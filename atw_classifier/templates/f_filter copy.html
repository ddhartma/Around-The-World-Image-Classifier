{% extends "a_layout.html" %}
{% block content %}

{% load static %}
<!-- script for DatePicker -->
<script src="{% static 'datepicker-full.min.js' %}"></script>
<form method = "post" action = "{% url 'filter_results' %}">

<div class="row">
    <div class="column">
        
        <div class="divTable">
            <div class="divTableBody">
                <!--Row 1-->
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;</div>
                    <div class="divTableCell">&nbsp;
                        <h4>Choose</h4>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <h4>Actual setting</h4>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <h4>Class Logic</h4>
                    </div>
                </div>
                <!--Row 2-->
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;
                        <h3>Yolo classes</h3>
                    </div>
                    <div class="divTableCell">&nbsp;
                        {% csrf_token %}
                        <select class="select" id="drop1_selection" onchange="set_drop1()">
                            {% for k in yolo_select %}
                                <option>{{ k }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="text" id="set_drop1_in" name="drop1" value={{selected_yolo}} onclick="set_drop1()">
                    </div>
                    <div class="divTableCell">&nbsp;
                        <h3 id="logic_state" style="color: blue"> AND</h3> 
                    </div>
                </div>
                <!--Row 3-->
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;
                        <h3>ImageNet classes</h3>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <select class="select" id="drop2_selection" onchange="set_drop2()">
                            {% for k in imageNet_select %}
                                <option>{{ k }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="text" id="set_drop2_in" name = "drop2" value={{selected_imageNet}}>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <label class="switch">
                            <input type="checkbox" id="switchvalue" name="selected_logic_sl" {{selec_log}} onclick="set_logic()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <!--Row4 4-->
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;
                        <h3>Date: from / to</h3>
                    </div>
                    <div id="range" class="divTableCell">&nbsp;
                        <input type="text" name="start" value={{selected_start}}>
                        <span>To</span>
                        <input type="text" name="end" value={{selected_end}}>
                    </div>
                    <div class="divTableCell">&nbsp;</div>
                    <div class="divTableCell">&nbsp;</div>
                </div>
            </div>
        </div>
    
        
    </div>
    <div class="column">

        <div class="divTable">
            <div class="divTableBody">
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;</div>
                    <div class="divTableCell">&nbsp;
                        <h4>GPS Filter: <span id="gps_state" style="color: blue"> ON</span></h4> 
                    </div>
                    <div class="divTableCell">&nbsp;</div>
                    <div class="divTableCell">&nbsp;</div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;
                        <h3>GPS</h3>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <label class="switch">
                            <input type="checkbox" id="switchvalue_gps" name="selected_gps_state" {{selec_gps}} onclick="set_gps()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="divTableCell">&nbsp;</div>
                    <div class="divTableCell">&nbsp;</div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;
                        <h3>Latitude/Longitude/Radius</h3>
                        Lat:   <input type="text"  id="cur_loc_lat" name="current_location_lat" value={{current_loc_lat}}>
                        Long:  <input type="text"  id="cur_loc_lon" name="current_location_lon" value={{current_loc_lon}}>
                        Radius/km:  <input type="text"  id="cur_rad" name="current_radius" value={{current_rad}}>
                    </div>
                    <div class="divTableCell">&nbsp;
                       
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="text"  id="cur_loc_lon" name="current_location_lon" value={{current_loc_lon}}>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="text"  id="cur_rad" name="current_radius" value={{current_rad}}>
                    </div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">&nbsp;
                        <h3>Radius</h3>
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="range" min="20" max="1000000" value="500000" class="slider_rad" id="gps_radius_range_slider" onchange="slider_func()">
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="range" min="2.5" max="20"  step="0.1" value="5" class="slider_rad" id="gps_zoom_slider" name="current_zoom" onchange="slider_func_zoom()">
                    </div>
                    <div class="divTableCell">&nbsp;
                        <input type="submit" value="Submit">
                    </div>
                </div>
            </div>
        </div>
    
    </div>
</div>

<div class="row">
    <div class="column">
        <div class="card">
            <p id="gps_data_available"></p>
            <div id="map"></div>
        </div>

        
    </div>
    <div class="column">

        <div class="card">
            <div class="divTable">
                <div class="divTableBody">
                    <div class="divTableRow">
                        <div id="image_box" class="divTableCell">&nbsp;</div>
                        <div id="image_box_description" class="divTableCell">&nbsp;</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" style="height: 800px; overflow-y: auto">

            {% for photo in photos_class %}
                
            {% if photo.file %}
                
                <img src='{{ photo.file.url }}' height='200' class="image" onclick="image_event(href='{{ photo.file.url }}', '{{ photo.file }}')"/> 
           
            {% endif %}
                
            {% endfor %}
        
            
        </div>

    </div>
</div>

<script>
    var position_to_center = {lat: 0, lng: 0};
    const elem = document.getElementById('range');
    const dateRangePicker = new DateRangePicker(elem, {
        // options here
    });
</script>

<script>
    let map;
    let markersArray = [];
    var marker = "";
    var circle = "";
    var radius = 500000;
    var latLng = "";
    
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: {{current_loc_lat}}, lng: {{current_loc_lon}}},
            zoom: {{curr_zoom}}
        });
        // map onclick listener 
        map.addListener('click', function(e) {
            //console.log(e);
            addMarker(e.latLng);
        });

        var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
        
        {% for latitude, longitude, img_path, date_time, GPS, classes_yolo, classes_ImgNet, photo in markers_and_infos %}
        travel_marker = new google.maps.Marker({
            map: map,
            position: {lat: {{latitude}}, lng: {{longitude}}},
            draggable: false,
            icon: image
        });

        var infowindow = new google.maps.InfoWindow();  
        google.maps.event.addListener(travel_marker, 'click', (function(travel_marker) {  
           return function() {  
               var content = '<div>' +
                          '<h4>Image Path</h4><p> {{ img_path }} </p>' +
                          '<h4>Date & Time</h4><p> {{ date_time }} </p>' +
                          '<h4>GPS</h4><p> {{ GPS }} </p>' +
                          '<h4>classes_yolo</h4><p> {{ classes_yolo }} </p>' +
                          '<h4>classes_ImgNet</h4><p> {{ classes_ImgNet }} </p>' +
                          '<img src="{{ photo.file.url }}" alt="Image"  height="300"> ' +
                          '</div>';  
               infowindow.setContent(content);  
               infowindow.open(map, travel_marker);  
           }  
         })(travel_marker));  
        {% endfor %}
        
     
        {% if current_loc_lat  != '0' %}
            marker = new google.maps.Marker({
            map: map,
            position: {lat: {{current_loc_lat}}, lng: {{current_loc_lon}}},
            draggable: true,
            });
            var position = marker.getPosition();
            circle = new google.maps.Circle({
                center: position,
                radius: {{current_rad}},
                fillColor: "#0000FF",
                fillOpacity: 0.1,
                map: map,
                strokeColor: "#FFFFFF",
                strokeOpacity: 0.1,
                strokeWeight: 2
            });
            updateRadius(circle, circle.radius);
            circle.bindTo('center', marker, 'position');
            
        {% endif %}

    }


    // define function to add marker at given lat & lng
    function addMarker(latLng) {
      latLng = latLng;
      if(marker){
        marker.setMap(null);
       
      }
      if(circle){
        circle.setMap(null);
      }

      
      marker = new google.maps.Marker({
          map: map,
          position: latLng,
          draggable: true,
          
      });

      google.maps.event.addListener(marker, 'dragend',
        function(marker) {
          latLng = marker.latLng;
          var inputF = document.getElementById("id1"); 
          
          document.getElementById("cur_loc_lat").value = latLng.lat().toFixed(3);
          document.getElementById("cur_loc_lon").value = latLng.lng().toFixed(3);
      
        }
      );

      position_to_center = marker.getPosition();
      circle = new google.maps.Circle({
        center: position_to_center,
        radius: radius,
        fillColor: "#0000FF",
        fillOpacity: 0.1,
        map: map,
        strokeColor: "#FFFFFF",
        strokeOpacity: 0.1,
        strokeWeight: 2
      });
     
      document.getElementById("cur_loc_lat").value = latLng.lat().toFixed(3);
      document.getElementById("cur_loc_lon").value = latLng.lng().toFixed(3);
      circle.bindTo('center', marker, 'position');

    }
    
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBTnwDxiw0bk2fJ1N55V4CAzlgtDxSWpoM&callback=initMap">
  </script>

<!-- SCRIPT SLIDER -->
  <script>

    var radius = parseFloat(document.getElementById("gps_radius_range_slider").value);
    var a = radius / 1000;
    document.getElementById("cur_rad").value = a;
  
    function slider_func() {
      radius = parseFloat(document.getElementById("gps_radius_range_slider").value);
      a = radius / 1000;
      document.getElementById("cur_rad").value = a;
      updateRadius(circle, radius)
    }

    function updateRadius(circle, rad){
    circle.setRadius(rad);
    }
  </script>

<!-- SCRIPT SLIDER ZOOM -->
<script>
    var zoom_level = 5;
    function slider_func_zoom(){
        zoom_level = document.getElementById("gps_zoom_slider").value;
        console.log(zoom_level)
        map.setCenter(position_to_center);
        map.zoom = zoom_level;
        map.panBy(0, 0);
   
    }
</script>

 <!-- SWITCH LOGIC STATE -->
 <script>
    var checkBox = document.getElementById("switchvalue");
    console.log(checkBox.checked);
    var logic_state = document.getElementById("logic_state");
    if (checkBox.checked == true){
        logic_state.innerHTML = "OR";
    } else {
        logic_state.innerHTML = "AND";
    }
  function set_logic() {
    var checkBox = document.getElementById("switchvalue");
    console.log(checkBox.checked);
    var logic_state = document.getElementById("logic_state");
    if (checkBox.checked == true){
        logic_state.innerHTML = "OR";
    } else {
        logic_state.innerHTML = "AND";
    }
  }
 </script>

  <!-- SWITCH GPS STATE -->
 <script>
   var checkBox = document.getElementById("switchvalue_gps");
    console.log(checkBox.checked);
    var gps_state = document.getElementById("gps_state");
    if (checkBox.checked == true){
        gps_state.innerHTML = "ON";
    } else {
        gps_state.innerHTML = "OFF";
    }
  function set_gps() {
    var checkBox = document.getElementById("switchvalue_gps");
    console.log(checkBox.checked);
    var gps_state = document.getElementById("gps_state");
    if (checkBox.checked == true){
        gps_state.innerHTML = "ON";
    } else {
        gps_state.innerHTML = "OFF";
        //map.setCenter({lat: 0, lng: 0});

        //map.zoom = -1;
        //if(circle){
        //    circle.setMap(null);
        }
    }

 </script>
 <script>
    function set_drop1(){
        document.getElementById("set_drop1_in").value = drop1_selection.options[drop1_selection.selectedIndex].text;
    }
    function set_drop2(){
        document.getElementById("set_drop2_in").value = drop2_selection.options[drop2_selection.selectedIndex].text;
    }
 </script>

<!-- SCRIPT Thumbnail images -->
<script>
    
    var markers_and_infos_json = {{ markers_and_infos_json|safe }};
    console.log(markers_and_infos_json);

    $('img').mouseover(function(){
    $(this).css('opacity','.5');
    $(this).next('span.text').show();
    }).mouseout(function(){
    $(this).css('opacity','1');
    $(this).next('span.text').hide(); 
    console.log(this.src)
      
    });
    

    function image_event(href, image){
        for (i = 0, len = markers_and_infos_json.length; i < len; i++) {
            console.log(markers_and_infos_json)
            if (markers_and_infos_json[i][2] == image){
            
                var src_image = "<img src="+ href + " width='600'></img>";
                var src_text =
                    '<h4>Image Path</h4><p>' + markers_and_infos_json[i][2] + '</p>' +
                    '<h4>Date & Time</h4><p>' + markers_and_infos_json[i][3]  + '</p>' +
                    '<h4>GPS</h4><p>' + markers_and_infos_json[i][4]  + '</p>' +
                    '<h4>classes_yolo</h4><p> ' + markers_and_infos_json[i][5]  + '</p>' +
                    '<h4>classes_ImgNet</h4><p>' + markers_and_infos_json[i][6]  + '</p>';
                
                document.getElementById("image_box").innerHTML = src_image;
                document.getElementById("image_box_description").innerHTML = src_text;

                
                if (markers_and_infos_json[i][0] != 'None'){

                    map.setCenter({lat: markers_and_infos_json[i][0], lng: markers_and_infos_json[i][1]});
                    map.zoom = zoom_level;

                    position_to_center = {lat: markers_and_infos_json[i][0], lng: markers_and_infos_json[i][1]};

                    if(marker){
                        marker.setMap(null);
                    }
                
                    if(circle){
                        circle.setMap(null);
                    }
                    
                    circle = new google.maps.Circle({
                    
                        center: position_to_center,
                        radius: 100000,
                        fillColor: "#0000FF",
                        fillOpacity: 0.1,
                        map: map,
                        strokeColor: "#FFFFFF",
                        strokeOpacity: 0.1,
                        strokeWeight: 2
                    });
                    document.getElementById("gps_data_available").innerHTML = "";
                    document.getElementById("cur_loc_lat").value = markers_and_infos_json[i][0].toFixed(3);
                    document.getElementById("cur_loc_lon").value = markers_and_infos_json[i][1].toFixed(3);
                    
                }else {
                    map.setCenter({lat: 0, lng: 0});
                    map.zoom = 2.5;
                    map.panBy(0, 0);
                    document.getElementById("gps_data_available").innerHTML = "NO GPS DATA";
                    

                }
       
            }
        }
        if (zoom_level <10){
            circle.setRadius(radius);
        } else{
            circle.setRadius(50);
        }
        map.panBy(0, 0);

    };
</script>

</form> 




{% endblock %}